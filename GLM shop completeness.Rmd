---
title: "GLM shop completeness"
author: "Josephine Brückner"
date: "19 4 2021"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(MASS)
library(ggplot2)
#library(VGAM)
#library(polycor)
library(plotly)
library(tidyverse)
#library(stats)
library(car)
require(ggeffects)
```

```{r, include=FALSE}
TabFactors <- read.csv2("TabFactors.csv")

# populationDensity: inhabitants per km² (for 2018)
# avShops: current number of retail stores as average value from 2018 to 2020
# asymptote: estimated asymptote via nonlinear regression
# completeness: estimated completeness level [%]
# func: best fit function (SSlogis = three parameter logistic function, SSfpl = four parameter logistic, SSasymp = asymptotic function, SSmicmen = Michaelis-Menten function)
# RS:

# factors:
# district type: 
# 1 = independent city
# 2 = urban district
# 3 = rural district
# unemployments: rate of unemployed in the civilian labor force [%] (for 2017)
# academics: employees to social security contributions at the place of residence with an academic qualification per 100 inhabitants of working age (for 2017)
# GDP: the gross domestic product (GDP) per person in employment [1000 €] (for 2016)


TabFactors$completeness <- as.numeric(as.character(TabFactors$completeness))

# define district type factor and factor levels
TabFactors$districtTypeF <- factor(TabFactors$districtType, levels=c(3,2,1), labels = c("rural districts", "urban districts", "independent cities"))

TabFactorsAll <- TabFactors
TabFactorsAll$notSaturated <- is.na(TabFactorsAll$asymptote)
# delete rows, asymptote = NA
TabFactors <- TabFactors[-c(which(is.na(TabFactors$asymptote))),]

```

```{r}
TabFactors$district <- gsub(pattern="\xf6", replacement = "ö", TabFactors$district)
TabFactors$district <- gsub(pattern="\xe4", replacement = "ä", TabFactors$district)
TabFactors$district <- gsub(pattern="\xdf", replacement = "ß", TabFactors$district)
TabFactors$district <- gsub(pattern="\xfc", replacement = "ü", TabFactors$district)
```


# GLM
```{r}
g <- glm(asymptote ~ districtTypeF + GDP + unemployments + academics + offset(log(avShops)),  data=TabFactors, family=poisson)

## deviance, estimates and significance
1-g$deviance/g$null.deviance
summary(g)
exp(coef(g))

## VIF

vif(g)
```

## Adjust for overdispersion

Use a negative binomial GLM to account for the overdisperion

```{r}
g <- glm.nb(asymptote ~ districtTypeF + GDP + unemployments + academics + offset(log(avShops)),  data=TabFactors)

## deviance, estimates and significance
1-g$deviance/g$null.deviance
summary(g)
exp(coef(g))

## VIF

vif(g)
```

Need to simplify model:

```{r}
g <- update(g, ~. -academics)
summary(g)
vif(g)
```
```{r}
drop1(g)
```

```{r}
g <- update(g, ~. -GDP)
summary(g)
vif(g)
1 - g$deviance / g$null.deviance
```
Compare with model with GDP instead of unemployment rate

```{r}
g2 <- glm.nb(formula = asymptote ~ districtTypeF + GDP + offset(log(avShops)), data = TabFactors, link = log)
summary(g2)
```
Clearly worst, so we stick with g. Interaction?

```{r}
g2 <- glm.nb(formula = asymptote ~ districtTypeF * unemployments + offset(log(avShops)), data = TabFactors, link = log)
summary(g2)
```
Nope.

Quadratic effect?

```{r}
g2 <- glm.nb(formula = asymptote ~ districtTypeF + poly(unemployments,2) + offset(log(avShops)), data = TabFactors, link = log)
summary(g2)
```
Then we would need to drop the district types


```{r}
g2 <- glm.nb(formula = asymptote ~  poly(unemployments,2) + offset(log(avShops)), data = TabFactors, link = log)
summary(g2)
```



```{r}
AIC(g)
AIC(g2)
```

The model with only unemployment as a quadratic effect is (marginally) better than the one with district type and unemployment.

```{r}
ggplot(TabFactors, mapping= aes(x=unemployments, y=  asymptote, size= avShops)) + geom_point() + geom_smooth(method= "glm.nb", formula = y ~ poly(x,2) )
```

This means that - for the same amount of shops - the asymptote increases with unemployment before dropping if unemployment rate is above ~6.3. Effect on saturation is the other way around: saturation first decreases with unemployment rate before increasing again for higher unemployment rates.

```{r}
pred <- ggpredict(g2, terms="unemployments", condition= c(avShops=1600))
#pred2 <- ggpredict(g2, terms="unemployments", condition= c(avShops=800))
ggplot(pred, aes(x, predicted)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .1) +
  xlab("Unemployment rate") + ylab("Asymptote")

```

However, it might be simply the case that more urban areas have also a higher unemployment rate:

```{r}
ggplot(TabFactors, aes(x=districtTypeF, y= unemployments)) + geom_violin()
```

Yes, indepentend cities seem to have a clearly higher unemployment rate.

```{r}
gUenmp <- lm(unemployments ~ districtTypeF, data= TabFactors)
summary(gUenmp)
```
However, differences are not significant.
Nevertheless, it might make more sense to use the marginally worse model with unemployment rate and district type.

```{r}
summary(g)
```
This would mean saturation goes down with unemployment rate and is higher in independent cities compared to rural districts.

### Diagnostics
```{r}
plot(g, which=1:6, labels.id = TabFactors$district)
```

Nordsachsen is highly influential, characterized by a high cook's distance and a high leverage.

### What if we leave out Nordsachsen?

```{r}
#TabFactors$district
gPart <- glm.nb(asymptote ~ unemployments +  offset(log(avShops)),  data=TabFactors, subset= district != "Nordsachsen, rural district" )

## deviance, estimates and significance
1-gPart$deviance/gPart$null.deviance
summary(gPart)
```
If we drop Görlitz as another district with high leverage, the relationship with unemployment holds. Is the fitting of Görlitz suspicious as well?

```{r}
gPart <- glm.nb(asymptote ~ unemployments +  offset(log(avShops)),  data=TabFactors, subset= district != "Nordsachsen, rural district" | district != "Görlitz, rural district")

## deviance, estimates and significance
1-gPart$deviance/gPart$null.deviance
summary(gPart)
```
```{r}
gPart <- glm.nb(asymptote ~ unemployments + districtTypeF + offset(log(avShops)),  data=TabFactors, subset= district != "Nordsachsen, rural district" | district != "Görlitz, rural district")

## deviance, estimates and significance
1-gPart$deviance/gPart$null.deviance
summary(gPart)
```

# graphic representations
```{r}
# diagram shops and estimated asymptote
p1 <- ggplot(TabFactors, aes(x=avShops, y=asymptote, text=district)) + theme_minimal()  + labs(title="number of shops and asymptote") + ylab("asymptote") + xlab("number of shops") + 
  geom_point(lwd=0.5, alpha=0.8, aes(colour=districtTypeF)) +
  geom_abline(slope=1, intercept = 0, col="grey", lty=2) +
  theme(plot.title = element_text(size=10, face = "bold"))+ theme(axis.title.y=element_text(size=9)) +theme(axis.title.x=element_text(size=9))+ theme(legend.text = element_text(size = 9)) + theme(axis.text.y =  element_text(size = 7), axis.text.x =  element_text(size =7)) +
  #theme(legend.position = "bottom") +
  theme(legend.title = element_text(size = 9, face = "bold")) 

ggplotly(p1, Tooltip=c("district"))

#violin plot
ggplot(TabFactors, aes(x=districtTypeF, y=completeness, colour = districtTypeF)) + geom_violin(size=0.3) + 
  scale_fill_brewer(palette="Dark2") + geom_boxplot(width=0.1, size = 0.3)+
  #stat_summary(fun.y=median, geom="point", size=2, color="red")+
  #stat_summary(fun.y=mean, geom="point", shape=23, size=2)+
  labs(title = "completeness distribution by district type", y = "completeness level [%]", x="")+ theme(legend.position = "none") +  theme(plot.title = element_text(size=10, face="bold")) + theme(axis.title.y=element_text(size=9)) + theme(legend.text = element_text(size = 9)) + theme(axis.text.y =  element_text(size = 7), axis.text.x =  element_text(size =9, colour="black"))+
  geom_dotplot(binaxis='y', stackdir='center',position=position_dodge(1), binwidth=0.5, colour = "Black")
```

# What districts are not saturated?
These will be highly incomplete

```{r}
gSat <- glm(notSaturated ~ districtTypeF + unemployments + GDP, data=TabFactorsAll, family=binomial)
summary(gSat)
drop1(gSat)
gSat <- update(gSat, ~.- districtTypeF)
summary(gSat)
drop1(gSat)
gSat <- update(gSat, ~.- unemployments)
summary(gSat)
drop1(gSat)

```
Even if we exclude Nordsachsen no significant relationship with predictors.

```{r}
gSat <- glm(notSaturated ~ districtTypeF + unemployments + GDP, data=TabFactorsAll, family=binomial, subset= district != "Nordsachsen, rural district")
summary(gSat)
drop1(gSat)
gSat <- update(gSat, ~.- districtTypeF)
summary(gSat)
drop1(gSat)
gSat <- update(gSat, ~.- GDP)
summary(gSat)
drop1(gSat)

```

Even if we label Nordsachsen as not saturated we still get no significant relationship with predictors.

```{r}
ggplot(TabFactorsAll, aes(x=completeness)) + geom_histogram()
TabFactorsAll$notSaturated2 <- TabFactorsAll$notSaturated
idx <- which(TabFactorsAll$completeness < 50)
TabFactorsAll$notSaturated2[idx] <- TRUE
```


```{r}
gSat <- glm(notSaturated2 ~ districtTypeF + unemployments + GDP, data=TabFactorsAll, family=binomial)
summary(gSat)
drop1(gSat)
gSat <- update(gSat, ~.- districtTypeF)
summary(gSat)
drop1(gSat)
gSat <- update(gSat, ~.- GDP)
summary(gSat)
drop1(gSat)

```
